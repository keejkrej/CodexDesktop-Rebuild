"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const n=require("node:fs/promises"),m=require("node:path"),E=require("./main-A5zRgzkr.js");require("path");require("node:fs");require("node:child_process");require("node:string_decoder");require("node:crypto");require("node:buffer");require("node:os");require("node:net");require("crypto");require("child_process");const s=E.getTaggedLoggerLazy("applied-devbox-cache"),v=3e4,I=2e4,O="host-cache",S="applied-devbox-ls.json";function A(e){return m.join(e,O,S)}function h(){const e=process.env.CODEX_APP_APPLIED_DEVBOX_REFRESH_INTERVAL_MS;if(!e)return v;const t=Number(e);return!Number.isFinite(t)||t<=0?(s().warning("Invalid CODEX_APP_APPLIED_DEVBOX_REFRESH_INTERVAL_MS",{safe:{value:e},sensitive:{}}),v):t}function w(e){const t=e.trim();if(!t)return[];try{const i=JSON.parse(t);if(!Array.isArray(i))return s().warning("Applied devbox ls returned non-array JSON",{safe:{payloadPreview:t.slice(0,200)},sensitive:{}}),null;const a=i.filter(r=>typeof r=="string").map(r=>r.trim()).filter(r=>r.length>0);return[...new Set(a)]}catch{return s().warning("Applied devbox ls returned invalid JSON",{safe:{payloadPreview:t.slice(0,200)},sensitive:{}}),null}}async function b(e,t){await n.mkdir(m.dirname(e),{recursive:!0,mode:448});const i=`${e}.tmp-${process.pid}-${Date.now()}`;await n.writeFile(i,t,{encoding:"utf8",mode:384});try{await n.rename(i,e)}catch(a){const r=a?.code;if(r==="EEXIST"||r==="EPERM")await n.unlink(e).catch(()=>{}),await n.rename(i,e);else throw await n.unlink(i).catch(()=>{}),a}await n.chmod(e,384).catch(()=>{})}function C(e){const t=A(e.codexHome),i=e.refreshIntervalMs??h(),a=e.timeoutMs??I;let r=!1,o=!1,l=null;const d=async()=>{if(r||o)return;o=!0;const c=new AbortController;l=c;let p=!1;const g=setTimeout(()=>{p=!0,c.abort()},a);try{const u=E.spawnAsync({args:["applied","devbox","ls","--format","json"],signal:c.signal}),{stdout:y,code:D}=await u.wait();if(r||p||D!==0)return;const f=w(y);if(f==null)return;await b(t,JSON.stringify(f)),e.onCacheUpdated?.()}catch(u){if(r)return;s().warning("Applied devbox cache refresh failed",{safe:{},sensitive:{error:u}})}finally{clearTimeout(g),o=!1,l=null}};d();const _=setInterval(()=>{d()},i);return{dispose:()=>{r=!0,clearInterval(_),l?.abort()}}}exports.atomicWriteCacheFile=b;exports.parseAppliedDevboxLsOutput=w;exports.resolveAppliedDevboxCachePath=A;exports.resolveRefreshIntervalMs=h;exports.startAppliedDevboxCacheRefresher=C;
//# sourceMappingURL=applied-devbox-cache-CQqFdVkz.js.map
